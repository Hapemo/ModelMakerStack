# Introduction
This project comprises of an array of toolsets to help with the process of training yolo object detection models. Here are the following tools within this project.
- [Auto Trainer](#auto-trainer)
- [Do Augment](#do-augment)
- [View Images](#view-images)
- [Rand Augment Finder](#rand-augment-finder)
- [Augment Tweaker](#augment-tweaker)

Each of these tools can be used individually for their own functionality, or used together to support each other. This readme will be explaining how to get started with the project, the surface architecture of this project, followed by the instruction for each of these tools.

## Setting Up Environment
This set up would work on windows x64 architecture and some functionalities have been tested to work on Linux as well. 

To set up the python environment, you must first have python downloaded. Then navigate to this folder's directory and enter `pip install -r requirements.txt`. This will install all the required libraries. 

The torch library installed might be for cpu only, so to fix that, you will need to uninstall torch and reinstall the gpu version. Below is the command to do that. Check out [torch's website](https://pytorch.org/get-started/locally/) for more information on installing torch.

```
pip uninstall torch torchaudio torchvision -y
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

## Getting Started
To run the program you will need to configure the [main.conf](main.conf), below are the explanation on each configuration you can set.

operation = auto_trainer

- **[General][operation]** - The tool you want to use. There are 5 different types as listed. 
  - rand_augment_finder
  - auto_trainer
  - do_augment
  - view_images
  - augment_tweaker

- **[AutoTrainer][experimentFilePath]** - File path of experiment to run
- **[AutoTrainer][ultralyticsSettingPath]** - File path of ultralytics setting file, usually in the format of `C:/Users/username/AppData/Roaming/Ultralytics/settings.json

- **[ViewImages][folderPath]** - Folder path of images to view

- **[DoAugment][augmentPath]** - File path of augment configuration file
- **[DoAugment][sourcePaths]** - Folder paths of images to do augmentation on, you can include multiple folder paths, delimited by comma
- **[DoAugment][savePath]** - Folder path to save the augmented images

- **[AugmentTweaker][imagePath]** - Test Image to do augment tweaking operations on
- **[AugmentTweaker][saveDir]** - Folder path to save the files generated by Augment Tweaker
- **[AugmentTweaker][screenScale]** - Scale of the image to be presented, sometimes it may be too large or to small.

- **[AugmentFinder][configPaths]** - File path of the augment finder configuration file to use


## Architecture
All of the source codes resides in the src folder. The `main.py` script will select appropriate operation based on the `main.conf` setting. It will run one of the file in [operation folder](./src/Ops/), which will either run on it's own or with the assistance of other scripts in other source files. 

## Auto Trainer
read me in progress.

### Dataset configuration file
This configuration file is the same format as required by original ultralytics training. You can follow original [ultralytics dataset guide](https://docs.ultralytics.com/datasets/#what-are-the-unique-features-of-ultralytics-yolo-models-for-computer-vision) or changing the [dataset demo file](./datasetConfig/DatasetConfigDemo.yaml) to fit your use case. Note, the `path` setting in the yaml file is relative to the dataset path specified in ultralytics setting path, which would be `./datasets` from the current directory by default. 

### Auto Trainer configuration file
This configuration file specify how a yolo detection model should be trained, it's parameters, additional operations and file paths. Please note, the usage of `true` and `false` is also equate to `1` and `0` respectively in configuration file.

- **[log][mlflow]**: enable or disable mlflow logging, for experiment tracking. 
- **[log][export_onnx]**: enable or disable exporting final model as onnx.
- **[model][modelpath]**: path to the pretrained model.
- **[model][nullImgPath]**: path to null image. Any image would do. 
- **[mode][test]**: enable or disable running of evaluation on model. If this is active, train cannot be active. 
- **[mode][train]**: enable or disable running of model training. If this is active, test cannot be active. 
- **[test][data]**: path to data config file for testing.
- **[test][batch]**: batch size for evaluation process.
- **[train][auto_augmentation]**: enable or disable auto augmentation from ultralytics. Auto augmentation techniques includes Mosaic, RandomPerspective, MixUp, Albumentations, RandomHSV, RandomFlip and RandomFlip. The values for augmentation here are fixed in backend library and not easily changeable.
- **[train][modelStoragePath]**: Path to store the model, if not given, it will only be stored in the run directory. if you want pt file, end it with pt. If you want onnx file, end it with onnx, provided [log][export_onnx] is 1. You can indicate more than one file, separated by comma, to facilitate saving of onnx and pt file. 
- **[train][data]**: path to data config file for training.
- **[train][batch]**: batch size for training process. Indicating -1 will allow ultralytics to automatically find the batch size value that utilizes 60% of the GPU memory. 

Only 3 varaibles in `[train]` is mentioned? Yes, because you can find out more about the other variables at [ultralytic's page](https://docs.ultralytics.com/modes/train/#train-settings).

## Do Augment
read me in progress. 

### Do Augment configuration file
The [Do Augment configuration file](./augmentConfigs/AugmentDemo.conf) specifies the augmentation operations and their parameters. Below is an explanation of its sections:

- **[General]**: Specifies which augmentations are enabled (1) or disabled (0). Each augmentation corresponds to a specific transformation applied to the images.
- **[AugmentationName]**: Each section defines the parameters for a specific augmentation. For example:
    - `brightness`: Range of brightness adjustment.
    - `contrast`: Range of contrast adjustment.
    - `scale`: Scaling factor for affine transformations.
    - `p`: Probability of applying the augmentation.

#### Notes
- Ensure the file paths and parameter ranges are correctly set for your dataset.
- Some augmentations may not work properly with certain backends or image types, as noted in the comments of the configuration file.
- Use this file as input for the `Do Augment` tool by specifying its path in the `[DoAugment][augmentPath]` setting in `main.conf`.
- RandomGridShuffle operation may not work properly as the library is outdated. 


## View Images
read me in progress. 

## Rand Augment Finder
Rand Augment Finder is a tool that attempts to find the best parameter for the [Rand Augment](https://arxiv.org/pdf/1909.13719) algorithm. There are 2 main parameters, number of augmentation operations (N) and magnitude of augmentation (M). The tool will loop through the specified range of N and M using grid search algorithm to search for the best combination of N and M.

To utilize this tool, you will need to configure a [Auto Trainer configuration file](#auto-trainer-configuration-file), [Do Augment configuration file](#do-augment-configuration-file) and [Rand Augment Finder configuration file](#rand-augment-finder-configuration-file).

### Rand Augment Finder configuration file
The [Rand Augment Finder configuration file](./augmentFinderConfigs/AutoAugment.conf) specifies the parameters for the Rand Augment Finder tool. Below is an explanation of its sections:

### General Section
- **`name`**: Name of the rand augment finder experiment.
- **`default_augmentation`**: Path to the default augmentation configuration file.
- **`train_config`**: Path to the Auto Trainer configuration file.
- **`epochs`**: Number of epochs to train for each combination of N and M.
- **`debug_save_dir`**: Directory to save debug information.
- **`N_min`, `N_max`, `N_step`**: Range and step size for the number of augmentation operations (N).
- **`M_min`, `M_max`, `M_step`**: Range and step size for the magnitude of augmentation (M).
- **`metric`**: Metric to optimize during the grid search, this will be the metric presented when generating a heatmap of the grid search. Options include:
    - `0`: Precision
    - `1`: Recall
    - `2`: mAP50
    - `3`: mAP50-95
    - `4`: Fitness

### Augmentation Sections
This configuration file contains the magnitude scalar control for the augmentation parameters. Some augmentation parameters are more sensitive to changes than others, so you might want to adjust their rate of change. 

- If the scalar value is `x` and the magnitude is `y`, the new magnitude will be `x * y`.
- A scalar value of `1` means no change to the rate of change, `0.5` means half the change, `2` means double the change, and so on.
- A scalar value of `0` disables changes to that parameter entirely, ensuring the grid search does not modify it.

Below is an example:

- **`[AdvanceBlur]`**:
    - `blur_limit`: 3
    - `sigma_x_limit`: 0.5
    - `sigma_y_limit`: 0

This means that blur_limit will increase 3 times more on each magnitude step forward and sigma_x_limit will only increase 0.5 times more instead. sigma_y_limit parameter will not be affected by the magnitude step forward.

### Notes
- Ensure the file paths and parameter ranges are correctly set for your dataset and experiment.
- Use this file as input for the Rand Augment Finder tool by specifying its path in the `[AugmentFinder][configPaths]` setting in `main.conf`.
- These augmentations are set and hardcoded, although more can be added from albumentations in the codebase if required.
- Refer to the comments in the configuration file for additional details on each parameter.

For a complete example, see the [AutoAugment.conf](./augmentFinderConfigs/AutoAugment.conf) file provided in this repository.

## Augment Tweaker
The Augment Tweaker tool allows you to interactively adjust augmentation parameters and generate configuration files for use in Do Augment and Rand Augment Finder. It is especially useful for Rand Augment Finder as it allows you to control the exact minimum and maximum augmentation effect to search through. It also provides a visual interface to tweak augmentation settings and observe their effects on a sample image in real time.

### Usage Instructions
As you meddle with the keyboard controls to test the different augmentations, you can also view the console for more information on the operation you just performed. 

1. **Keyboard Controls**:
    - `[` and `]`: Switch between augmentation types.
    - `Up Arrow` and `Down Arrow`: Increase or decrease the current parameter value.
    - `Left Arrow` and `Right Arrow`: Switch between parameters of the current augmentation.
    - `P`: Print the current value of the selected parameter.
    - `-` and `=`: Decrease or increase the adjustment step size. You can only use integer values if the parameter only accepts integer, like number of shadows in random shadow operation.
    - `N`: Save the current augmentation parameters as the minimum configuration, used for generating rand augment finder configuration
    - `M`: Save the current augmentation parameters as the maximum configuration, used for generating rand augment finder configuration
    - `B`: Generate and save the augmentation and finder configuration files.
    - `L`: Load an existing configuration file to adjust.
    - `S`: Save the current augmentation configuration.
    - `Esc`: Exit the program.

2. **Output Files**:
    - **Augment Configuration File**: Contains the adjusted augmentation parameters.
    - **Finder Configuration File**: Includes the magnitude scalar controls for grid search in Rand Augment Finder. You will need to fill in the blanks after generating the base template file. 

#### Notes
- The tool uses the `albumentations` library for augmentations. Refer to the source code for the list of supported augmentations and their parameters.
- Ensure the test image is correctly set in `main.conf` to visualize the effects of the augmentations.
- The generated configuration files can be used with the `Do Augment` and `Rand Augment Finder` tools for further experimentation.

For more details, refer to the source code in [`AugmentTweaker.py`](./src/Ops/AugmentTweaker.py).






